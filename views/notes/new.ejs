<!DOCTYPE html>
<html>
  <head>
    <title>New Note | StudyBuddy</title>
    <link href="/css/styles.css" rel="stylesheet" />
  </head>
  <body>
    <%- include('../partials/header') %>
    <main class="app-shell">
      <section class="app-grid">
        <%- include('../partials/sidebar') %>
        <div class="main-card">
          <h2>Create Note</h2>
          <form id="noteForm" action="/notes/form/create" method="POST" enctype="multipart/form-data">
            <label class="form-label">Title</label>
            <input name="title" class="form-control mb-2" required />

            <label class="form-label">Content</label>
            <textarea name="content" class="form-control mb-2" rows="8"></textarea>

            <label class="form-label">Tags (choose or add)</label>
            <select id="tagSelect" multiple style="width:100%;padding:8px;border-radius:8px;margin-bottom:8px">
              <% (userTags || []).forEach(t => { %>
                <option value="<%= t %>"><%= t %></option>
              <% }) %>
            </select>

            <div style="display:flex;gap:8px;margin-bottom:12px">
              <input id="newTag" class="form-control" placeholder="Add a new tag (e.g. Movies)" />
              <button id="addTagBtn" type="button" class="btn btn-ghost btn-sm">Add</button>
            </div>

            <input type="hidden" name="tags" id="tagsField" value="" />

            <div style="display:flex;gap:8px">
              <button class="btn btn-primary">Create</button>
              <a href="/dashboard" class="btn btn-ghost">Cancel</a>
            </div>
          </form>
        </div>
      </section>
    </main>
    <%- include('../partials/footer') %>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const addBtn = document.getElementById('addTagBtn');
        const newTag = document.getElementById('newTag');
        const tagSelect = document.getElementById('tagSelect');
        const tagsField = document.getElementById('tagsField');
        const form = document.getElementById('noteForm');

        addBtn.addEventListener('click', () => {
          const v = (newTag.value || '').trim();
          if (!v) return;
          // add option if not present
          if (![...tagSelect.options].some(o=>o.value.toLowerCase()===v.toLowerCase())) {
            const opt = document.createElement('option');
            opt.value = v; opt.text = v; opt.selected = true;
            tagSelect.appendChild(opt);
          } else {
            [...tagSelect.options].forEach(o => { if (o.value.toLowerCase()===v.toLowerCase()) o.selected = true; });
          }
          newTag.value = '';
        });

        form.addEventListener('submit', () => {
          const selected = [...tagSelect.selectedOptions].map(o => o.value.trim()).filter(Boolean);
          tagsField.value = selected.join(','); // server accepts comma string or array
        });
      });
    </script>
  </body>
</html>